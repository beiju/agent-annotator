(this["webpackJsonplabelbox-annotator"]=this["webpackJsonplabelbox-annotator"]||[]).push([[0],{100:function(e,t,a){},109:function(e,t,a){},115:function(e,t,a){},116:function(e,t,a){},122:function(e,t,a){},124:function(e,t,a){"use strict";a.r(t);var n=a(1),c=a.n(n),r=a(19),s=a.n(r),i=(a(100),a(3)),l=a(5),o=a(132),u=a(133),d=a(134),j=a(140),b=a(30),h=a(21),v=a(138),g=a(137),m=a(86),f=a(47),O=a(91),p=a(79),x=Object(n.createContext)({}),y=a(50),_=a.n(y),k=a(93),w=a(92),M=(a(109),"3000"===window.location.port?"//127.0.0.1:8011":"");function C(e,t){return e?"".concat(M,"/api/frame.jpg?experiment=").concat(e,"&frame=").concat(t):""}var N=a(85),A=a.n(N),S=(a(115),a(4)),F=(a(116),a(94)),I=a(141),E=a(2),T=["popper","children","show"];function P(e,t){var a;return t===e.activeFrame?"active":(null===(a=e.frames)||void 0===a?void 0:a[t])?"labeled":"unlabeled"}var H=Object(n.forwardRef)((function(e,t){var a=e.popper,c=e.children,r=(e.show,Object(S.a)(e,T));return Object(n.useEffect)((function(){a.scheduleUpdate()}),[c,a]),Object(E.jsx)(F.a,Object(i.a)(Object(i.a)({ref:t,body:!0},r),{},{children:c}))}));function B(e){var t=e.sample,a=e.state,c=Object(n.useContext)(x),r=Object(n.useMemo)((function(){for(var e=[],n=null,c=0,r=1;r<=t.numFrames;r++){var s=P(a,r);s!==n&&null!==n&&(e.push({componentType:n,componentLength:c}),c=0),c+=1,n=s}return 0!==c&&e.push({componentType:n,componentLength:c}),e}),[t.numFrames,a]),s=Object(n.useState)(null),i=Object(l.a)(s,2),o=i[0],u=i[1],d=Object(n.useState)(null),j=Object(l.a)(d,2),b=j[0],h=j[1];var g=null===o?null:Math.min(Math.floor(o*t.numFrames),t.numFrames-1);return Object(E.jsxs)(E.Fragment,{children:[Object(E.jsxs)(v.a,{show:null!==b,onHide:function(){return h(null)},children:[Object(E.jsx)(v.a.Header,{closeButton:!0,children:Object(E.jsxs)(v.a.Title,{children:["Jump to frame ",b,"?"]})}),Object(E.jsx)(v.a.Body,{children:Object(E.jsx)("p",{children:"You will automatically start annotating at this position. Removing annotations is not yet supported, so be sure this is the frame you want."})}),Object(E.jsxs)(v.a.Footer,{children:[Object(E.jsx)(m.a,{onClick:function(){return h(null)},variant:"secondary",children:"Cancel"}),Object(E.jsx)(m.a,{onClick:function(){c({type:"jump_to_frame",frame:b}),h(null)},variant:"primary",children:"Jump to frame"})]})]}),Object(E.jsxs)("div",{className:"timeline",onMouseMove:function(e){var t=e.currentTarget.getBoundingClientRect(),a=(e.clientX-t.x)/t.width;u(Math.max(0,Math.min(a,1))),e.preventDefault()},onMouseLeave:function(){u(null)},onClick:function(){h(g)},children:[null!==g&&Object(E.jsx)(I.a,{show:!0,placement:"top",overlay:Object(E.jsx)(H,{className:"p-0",children:Object(E.jsx)("img",{src:C(t.id,g),alt:"Frame ".concat(g),height:180})}),children:Object(E.jsx)("div",{className:"timeline-cursor",style:{width:"min(2px, ".concat(100/t.numFrames,"%)"),left:"".concat(100*g/t.numFrames,"%")}})}),r.map((function(e,t){var a=e.componentType,n=e.componentLength;return Object(E.jsx)("div",{className:"timeline-component timeline-component-".concat(a),style:{flexGrow:n}},t)}))]})]})}var L=a(136),R=a(139),D=a(130),W=a(131),Y=a(135),z=a(142),U=a(80),J=a(89),X=a(90),G=a(81);function q(e){var t,a,c,r=e.sample,s=e.state,i=e.returnToIndex,o=e.save,u=Object(n.useContext)(x),d=Object(n.useState)(!1),j=Object(l.a)(d,2),b=j[0],h=j[1];return Object(E.jsxs)(E.Fragment,{children:[Object(E.jsxs)(L.a,{className:"d-flex justify-content-between",children:[Object(E.jsx)(R.a,{children:Object(E.jsxs)(L.a.Text,{children:[Object(E.jsx)(D.a,{animation:"border",size:"sm",className:"me-2 ".concat(s.loading?"visible":"invisible")}),"Frame ",s.activeFrame," of ",r.numFrames," (sampling every ",r.sampleRate," frames)"]})}),Object(E.jsx)(R.a,{children:Object(E.jsxs)(W.a,{children:[Object(E.jsx)(m.a,{onClick:function(){return u({type:"previous_frame"})},disabled:s.activeFrame<=1,children:Object(E.jsx)(U.a,{})}),Object(E.jsx)(m.a,{onClick:function(){return u({type:"next_frame"})},disabled:s.activeFrame+r.sampleRate>r.numFrames,children:Object(E.jsx)(U.b,{})})]})}),Object(E.jsxs)(R.a,{children:[Object(E.jsxs)(Y.a,{children:[Object(E.jsxs)(Y.a.Toggle,{children:[(null===(t=s.dishMask)||void 0===t?void 0:t.locked)?Object(E.jsx)(G.a,{style:{verticalAlign:"text-top"}}):Object(E.jsx)(G.b,{style:{verticalAlign:"text-top"}})," Dish mask"]}),Object(E.jsxs)(Y.a.Menu,{children:[(null===(a=s.dishMask)||void 0===a?void 0:a.locked)&&Object(E.jsx)(Y.a.Item,{onClick:function(){return u({type:"set_dish_mask_locked",value:!1})},children:"Unlock"}),!(null===(c=s.dishMask)||void 0===c?void 0:c.locked)&&Object(E.jsx)(Y.a.Item,{onClick:function(){return u({type:"set_dish_mask_locked",value:!0})},children:"Lock"}),Object(E.jsx)(Y.a.Item,{onClick:function(){return u({type:"reset_dish_mask"})},children:"Reset to center"})]})]}),Object(E.jsx)(m.a,{className:"mx-2",variant:b?"info":"outline-info",onClick:function(){return h(!b)},children:Object(E.jsx)(J.a,{})}),Object(E.jsx)(m.a,{className:"me-2",onClick:o,disabled:s.saving,children:s.saving?"Saving\u2026":"Save"}),Object(E.jsx)(m.a,{onClick:i,children:"Exit annotator"})]})]}),b&&Object(E.jsxs)(z.a,{border:"info",className:"mb-2",children:[Object(E.jsxs)(z.a.Header,{children:[Object(E.jsx)("button",{className:"float-end border-0",onClick:function(){return h(!b)},children:Object(E.jsx)(X.a,{})}),"Help"]}),Object(E.jsxs)(z.a.Body,{className:"row",children:[Object(E.jsxs)("dl",{className:"col mb-0",children:[Object(E.jsx)("dt",{children:"Space"}),Object(E.jsx)("dd",{children:"Advance through agents and frames"}),Object(E.jsx)("dt",{children:"b"}),Object(E.jsx)("dd",{children:"Reverse through agents and frames"})]}),Object(E.jsxs)("dl",{className:"col mb-0",children:[Object(E.jsx)("dt",{children:"q/e/scroll"}),Object(E.jsx)("dd",{children:"Rotate selected agent"}),Object(E.jsx)("dt",{children:"w/a/s/d/drag"}),Object(E.jsx)("dd",{children:"Move selected agent"})]}),Object(E.jsxs)("dl",{className:"col mb-0",children:[Object(E.jsx)("dt",{children:"Shift"}),Object(E.jsx)("dd",{children:"Rotate/move by 10x"})]})]})]})]})}function K(e,t,a,n){var c=new DOMMatrix([Math.cos(a),-Math.sin(a),Math.sin(a),Math.cos(a),e,t]);return n&&c.multiplySelf(new DOMMatrix([1,0,0,-1,0,0])),c}var Q=Symbol("DISH_MASK");function V(e){var t=e.sample,a=e.state,c=e.returnToIndex,r=e.save,s=Object(n.useContext)(x),i=Object(n.useState)(null),o=Object(l.a)(i,2),u=o[0],d=o[1],j=Object(n.useState)(null),h=Object(l.a)(j,2),v=h[0],g=h[1];Object(n.useEffect)((function(){var e=document.createElement("img");function n(){g(e),s({type:"set_loading_finished"})}return e.addEventListener("load",n),e.src=C(t.id,a.activeFrame),function(){return e.removeEventListener("load",n)}}),[s,t.id,a.activeFrame]);var m=Object(n.useMemo)((function(){var e,t,n,c,r,s;return v?{x:null!==(e=null===(t=a.dishMask)||void 0===t?void 0:t.x)&&void 0!==e?e:v.naturalWidth/2,y:null!==(n=null===(c=a.dishMask)||void 0===c?void 0:c.y)&&void 0!==n?n:v.naturalHeight/2,radius:null!==(r=null===(s=a.dishMask)||void 0===s?void 0:s.radius)&&void 0!==r?r:500}:null}),[v,a]),f=Object(n.useState)(null),p=Object(l.a)(f,2),y=p[0],k=p[1];Object(n.useEffect)((function(){u&&v&&(u.width=v.naturalWidth,u.height=v.naturalHeight,u.getContext("2d").save(),k(u))}),[u,v]),Object(n.useEffect)((function(){if(y&&m){var e=y.getContext("2d");e.restore(),e.save(),e.fillStyle="black",e.fillRect(0,0,y.width,y.height),e.beginPath();var t=m.x,a=m.y,n=m.radius;e.arc(t,a,n,0,2*Math.PI),e.clip()}}),[y,m]);var w=Object(n.useCallback)((function(e,t){var a,n,c,r,s;if(!y)throw new Error("Canvas ref was cleared");if(t===Q)return m;console.assert("string"===typeof t);var i=null!==(a=null===(n=e.frames[e.activeFrame])||void 0===n?void 0:n[t])&&void 0!==a?a:{};return{x:null!==(c=i.x)&&void 0!==c?c:y.width/2,y:null!==(r=i.y)&&void 0!==r?r:y.height/2,angle:null!==(s=i.angle)&&void 0!==s?s:0}}),[y,m]);function M(e){if(!y)throw new Error("Canvas ref was cleared");return{x:e.nativeEvent.offsetX*(y.height/y.clientHeight),y:e.nativeEvent.offsetY*(y.width/y.clientWidth)}}Object(n.useEffect)((function(){if(y&&v){var e=y.getContext("2d");e.setTransform(1,0,0,1,0,0),e.drawImage(v,0,0),e.lineWidth=2;for(var t=0,n=Object.entries(a.agents);t<n.length;t++){var c=Object(l.a)(n[t],2),r=c[0],s=c[1],i=_.a.hex.hsl(s.color.slice(1)),o=Object(l.a)(i,3),u=o[0],d=o[1],j=o[2];r===a.activeAgent?(e.strokeStyle="hsla(".concat(u,", ").concat(d,"%, ").concat(j,"%, 1)"),e.fillStyle="hsla(".concat(u,", ").concat(d,"%, ").concat(j,"%, 0.2)")):(e.strokeStyle="hsla(".concat(u,", ").concat(.25*d,"%, ").concat(j,"%, 1)"),e.fillStyle="hsla(".concat(u,", ").concat(.25*d,"%, ").concat(j,"%, 0.2)"));var h=w(a,r),g=h.x,m=h.y,f=h.angle;e.setTransform(K(g,m,f,!1)),e.beginPath();var O,p=Object(b.a)(s.shape);try{for(p.s();!(O=p.n()).done;){var x=Object(l.a)(O.value,2),k=x[0],M=x[1];e.lineTo(k,M)}}catch(C){p.e(C)}finally{p.f()}e.stroke(),e.fill()}}}),[y,w,v,a]),Object(n.useEffect)((function(){var e,t,n,c,r=null!==(e=null===(t=a.frames[a.activeFrame])||void 0===t?void 0:t[a.activeAgent])&&void 0!==e?e:{};s&&v&&("undefined"===typeof r.x||"undefined"===typeof r.y)&&s({type:"set_agent_position",agentId:a.activeAgent,x:null!==(n=r.x)&&void 0!==n?n:v.naturalWidth/2,y:null!==(c=r.y)&&void 0!==c?c:v.naturalHeight/2})}),[s,a,v]),Object(n.useEffect)((function(){(new Image).src=C(t.id,a.activeFrame+1),(new Image).src=C(t.id,a.activeFrame+2),(new Image).src=C(t.id,a.activeFrame+3)}),[t.id,a.activeFrame]);var N=Object(n.useState)(null),S=Object(l.a)(N,2),F=S[0],I=S[1];function T(e,t,n){n&&I({agentId:n,mouse:{x:e,y:t},agent:w(a,n)})}function P(e,t){for(var n=0,c=Object.entries(a.agents);n<c.length;n++){var r=Object(l.a)(c[n],2),s=r[0],i=r[1],o=w(a,s),u=e-o.x,d=t-o.y,j=u*Math.cos(-o.angle)+d*Math.sin(-o.angle),b=-u*Math.sin(-o.angle)+d*Math.cos(-o.angle);if(A()(i.shape,[j,b])<=0)return s}return null}function H(e,t){var n;if(null===(n=a.dishMask)||void 0===n?void 0:n.locked)return!1;var c=m.x,r=m.y,s=m.radius;return Math.pow(e-c,2)+Math.pow(t-r,2)>Math.pow(s,2)}function L(){return F&&(F.agentId===a.activeAgent||F.agentId===Q)}return Object(E.jsxs)(O.a,{className:"h-100 d-flex flex-column",children:[Object(E.jsx)(q,{sample:t,state:a,returnToIndex:c,save:r}),Object(E.jsxs)("div",{className:"labeler-canvas-container",children:[Object(E.jsx)("canvas",{className:"labeler-canvas",ref:d,onMouseDown:function(e){var t=M(e),n=t.x,c=t.y;if(H(n,c))T(n,c,Q);else{var r=P(n,c);r&&s({type:"set_active_agent",activeAgent:r}),T(n,c,null!==r&&void 0!==r?r:a.activeAgent)}},onMouseUp:function(){I(null)},onMouseMove:function(e){if(L()){var t=e.nativeEvent.offsetX*(y.height/y.clientHeight)-F.mouse.x,a=e.nativeEvent.offsetY*(y.width/y.clientWidth)-F.mouse.y;F.agentId===Q?s({type:"set_dish_mask_position",x:t+F.agent.x,y:a+F.agent.y}):s({type:"set_agent_position",agentId:F.agentId,x:t+F.agent.x,y:a+F.agent.y})}},onWheel:function(e){var t=M(e),n=function(e,t){var n;return L()?F.agentId:H(e,t)?Q:null!==(n=P(e,t))&&void 0!==n?n:a.activeAgent}(t.x,t.y);if(n===Q){var c=m.radius;s({type:"set_dish_mask_radius",radius:Math.max(10,c+e.deltaY/(e.shiftKey?10:100))})}else n&&(n!==a.activeAgent&&s({type:"set_active_agent",activeAgent:n}),s({type:"rotate_agent",agentId:n,by:e.deltaY/(e.shiftKey?1e3:1e4)}))}}),Object(E.jsx)(B,{sample:t,state:a})]})]})}function Z(e){var t=e.state,a=e.sample,c=e.agent,r=e.onClose,s=Object(n.useContext)(x),i=null===c?null:t.agents[c],o=Object(n.useState)(null),u=Object(l.a)(o,2),d=u[0],j=u[1],f=Object(n.useState)(null),O=Object(l.a)(f,2),p=O[0],y=O[1],k=Object(n.useState)(null),w=Object(l.a)(k,2),M=w[0],N=w[1],A=Object(n.useState)(null),S=Object(l.a)(A,2),F=S[0],I=S[1],T=Object(n.useState)(null),P=Object(l.a)(T,2),H=P[0],B=P[1];Object(n.useEffect)((function(){s({type:"set_modal",value:null!==i})}),[i,s]),Object(n.useEffect)((function(){var e=document.createElement("img");function n(){j(e)}return e.addEventListener("load",n),e.src=C(a.id,t.activeFrame),function(){return e.removeEventListener("load",n)}}),[a.id,t.activeFrame]);var L=Object(n.useState)([NaN,NaN,NaN,NaN]),R=Object(l.a)(L,2),D=Object(l.a)(R[0],4),W=D[0],Y=D[1],z=D[2],U=D[3],J=R[1];Object(n.useEffect)((function(){if(console.log("effect"),i){if(null===H){console.log("updating dimensions");var e=Math.min.apply(Math,Object(h.a)(i.shape.map((function(e){var t=Object(l.a)(e,2);t[0];return t[1]})))),t=Math.max.apply(Math,Object(h.a)(i.shape.map((function(e){var t=Object(l.a)(e,2);t[0];return t[1]})))),a=Math.min.apply(Math,Object(h.a)(i.shape.map((function(e){var t=Object(l.a)(e,2),a=t[0];t[1];return a})))),n=Math.max.apply(Math,Object(h.a)(i.shape.map((function(e){var t=Object(l.a)(e,2),a=t[0];t[1];return a}))));J([e,t,a,n])}}else console.log("clearing dimensions"),J([NaN,NaN,NaN,NaN])}),[i,H]),Object(n.useEffect)((function(){p&&d&&(p.width=d.naturalWidth,p.height=d.naturalHeight,p.getContext("2d").save(),N(p))}),[p,d]),Object(n.useEffect)((function(){M&&(console.log("updating canvas size"),M.width=5*(U-z)+500,M.height=5*(Y-W)+500)}),[M,W,Y,z,U,H]);var X=Object(n.useCallback)((function(e,t){var a,n,c,r,s;if(!M)throw new Error("Canvas ref was cleared");var i=null!==(a=null===(n=e.frames[e.activeFrame])||void 0===n?void 0:n[t])&&void 0!==a?a:{};return{x:null!==(c=i.x)&&void 0!==c?c:M.width/2,y:null!==(r=i.y)&&void 0!==r?r:M.height/2,angle:null!==(s=i.angle)&&void 0!==s?s:0}}),[M]),G=Object(n.useState)(null),q=Object(l.a)(G,2),Q=q[0],V=q[1];Object(n.useEffect)((function(){if(i&&M&&d){var e=M.getContext("2d"),a=X(t,c),n=K(5*a.x,5*a.y,a.angle,!1).inverse(),r=K(M.width/2,M.height/2,0,!1);e.setTransform(r.multiply(n)),e.scale(5,5),e.drawImage(d,0,0),e.scale(1,1),e.lineWidth=2;var s=_.a.hex.hsl(i.color.slice(1)),o=Object(l.a)(s,3),u=o[0],j=o[1],h=o[2];e.setTransform(1,0,0,1,M.width/2,M.height/2),e.strokeStyle="hsla(".concat(u,", ").concat(j,"%, ").concat(h,"%, 1)"),e.fillStyle="hsla(".concat(u,", ").concat(j,"%, ").concat(h,"%, 0.2)"),e.beginPath();var v,g=Object(b.a)(i.shape);try{for(g.s();!(v=g.n()).done;){var m=Object(l.a)(v.value,2),f=m[0],O=m[1];e.lineTo(5*f,5*O)}}catch(w){g.e(w)}finally{g.f()}e.stroke(),e.fill(),e.fillStyle="hsla(".concat(u,", ").concat(j,"%, ").concat(.5*h,"%, 0.8)");for(var p=0;p<i.shape.length;p++){var x=Object(l.a)(i.shape[p],2),y=x[0],k=x[1];e.beginPath(),p===F?(e.strokeStyle="#fff",e.arc(5*y,5*k,8,0,2*Math.PI)):(e.strokeStyle="hsla(".concat(u,", ").concat(j,"%, ").concat(.5*h,"%, 1)"),e.arc(5*y,5*k,5,0,2*Math.PI)),e.stroke(),e.fill()}Q&&(e.strokeStyle="#000",e.fillStyle="#000",e.beginPath(),e.arc(Q.x,Q.y,5,0,2*Math.PI),e.stroke(),e.fill())}}),[M,d,c,i,X,t,F,Q]);var Z=Object(n.useCallback)((function(e){if(!M)throw new Error("Canvas ref was cleared");return{x:e.nativeEvent.offsetX*(M.width/M.clientWidth)-M.width/2,y:e.nativeEvent.offsetY*(M.height/M.clientHeight)-M.height/2}}),[M]),$=Object(n.useCallback)((function(e){var t=Z(e),a=t.x,n=t.y;if(V({x:a,y:n}),null!==H)s({type:"set_agent_shape",agent:c,i:H,shapeX:a/5,shapeY:n/5});else{for(var r=null,o=0;o<i.shape.length;o++){var u=Object(l.a)(i.shape[o],2),d=u[0],j=u[1],b=Math.sqrt(Math.pow(5*d-a,2)+Math.pow(5*j-n,2));(null===r||r.dist>b)&&(r={dist:b,i:o})}null===r||r.dist>15?I(null):I(r.i)}}),[Z,c,i,H,s]);return Object(E.jsxs)(v.a,{show:null!==c,onHide:r,size:"lg",children:[Object(E.jsx)(v.a.Header,{closeButton:!0,children:Object(E.jsx)(v.a.Title,{children:"Edit Agent"})}),Object(E.jsxs)(v.a.Body,{children:[Object(E.jsxs)(g.a,{children:[i&&Object(E.jsxs)(g.a.Group,{className:"mb-3",controlId:"agentName",children:[Object(E.jsx)(g.a.Label,{children:"Agent Name"}),Object(E.jsx)(g.a.Control,{type:"text",value:i.display_name,onChange:function(e){s({type:"set_agent_display_name",agent:c,display_name:e.currentTarget.value})}})]}),Object(E.jsx)(g.a.Group,{className:"mb-3",controlId:"agentShape",children:Object(E.jsx)(g.a.Label,{children:"Edit agent shape. This affects all frames of this video. If this frame doesn't give a clear view, you can advance to another frame and Edit again."})})]}),Object(E.jsx)("canvas",{style:{cursor:null===F?"auto":"grab"},className:"agent-edit-canvas w-100",ref:y,onMouseMove:$,onMouseDown:function(){B(F)},onMouseUp:function(){B(null)}})]}),Object(E.jsx)(v.a.Footer,{children:Object(E.jsx)(m.a,{variant:"primary",onClick:r,children:"Done"})})]})}function $(e){var t=e.state,a=e.sample,c=Object(n.useContext)(x),r=Object(n.useState)(""),s=Object(l.a)(r,2),o=s[0],u=s[1],d=Object(n.useState)(null),j=Object(l.a)(d,2),b=j[0],h=j[1];if(!c)return null;return Object(E.jsxs)("div",{children:[Object(E.jsx)("h4",{className:"text-center mt-3",children:"Agents Present"}),Object(E.jsx)("p",{className:"small text-secondary text-center",children:"Applies to the entire video"}),Object(E.jsx)("ol",{className:"list-unstyled m-3",children:Object.entries(t.agents).map((function(e){var t=Object(l.a)(e,2),a=t[0],n=t[1];return Object(E.jsx)(ee,{agent:n,onColorChange:function(e){return c({type:"set_agent_color",agent:a,color:e})},onClickEdit:function(e){return h(a)},onClickDelete:function(e){return c({type:"delete_agent",agent:a})}},a)}))}),Object(E.jsxs)("div",{className:"input-group px-2 pb-3",children:[Object(E.jsxs)(g.a.Select,{"aria-label":"Agent Type",value:o,onChange:function(e){return u(e.currentTarget.value)},children:[Object(E.jsx)("option",{value:"",children:"Agent Type\u2026"},""),p.map((function(e){return Object(E.jsx)("option",{value:e.name,children:e.display_name},e.name)}))]}),Object(E.jsx)(m.a,{variant:"primary",onClick:function(e){return function(e){var t=p.find((function(t){return t.name===e}));t&&(c({type:"add_agent",agent:Object(i.a)(Object(i.a)({},t),{},{color:"#"+_.a.hsv.hex(360*Math.random(),100,100)})}),u(""))}(o)},disabled:!o,children:"Add"})]}),Object(E.jsx)(Z,{state:t,sample:a,agent:b,onClose:function(e){return h(null)}})]})}function ee(e){var t=e.agent,a=e.onClickEdit,n=e.onClickDelete,c=e.onColorChange;return Object(E.jsxs)("li",{className:"d-flex align-items-center",children:[Object(E.jsx)(g.a.Control,{type:"color",size:"sm",className:"agent-color",value:t.color,onChange:function(e){return c(e.currentTarget.value)},title:"Agent color"}),Object(E.jsx)("span",{className:"flex-grow-1 flex-truncate-text",children:t.display_name}),Object(E.jsx)(m.a,{className:"icon-button",size:"sm",variant:"light",onClick:function(e){return n()},children:Object(E.jsx)(w.a,{})}),Object(E.jsx)(m.a,{className:"icon-button",size:"sm",variant:"light",onClick:function(e){return a()},children:Object(E.jsx)(k.a,{})})]})}function te(e){var t,a,c=e.state,r=e.agentId,s=e.agent,i=e.label,l=Object(n.useContext)(x);return l?Object(E.jsxs)("li",{className:"list-group-item py-2 px-3 "+(c.activeAgent===r?"active":""),onClick:function(){return l({type:"set_active_agent",activeAgent:r})},children:[s.display_name,Object(E.jsxs)(g.a,{children:[Object(E.jsx)(f.a,{id:"agent-".concat(r,"-blurred"),label:"Blurred",checked:null!==(t=null===i||void 0===i?void 0:i.isBlurred)&&void 0!==t&&t,onChange:function(e){return l({type:"set_agent_is_blurred",agentId:r,isBlurred:e.currentTarget.checked})}}),Object(E.jsx)(f.a,{id:"agent-".concat(s.name,"-obscured"),label:"Obscured",checked:null!==(a=null===i||void 0===i?void 0:i.isObscured)&&void 0!==a&&a,onChange:function(e){return l({type:"set_agent_is_obscured",agentId:r,isObscured:e.currentTarget.checked})}})]})]}):null}function ae(e){var t=e.state;return Object(E.jsxs)("div",{className:"flex-grow-1",children:[Object(E.jsx)("h4",{className:"text-center mt-3",children:"Agent Annotations"}),Object(E.jsx)("p",{className:"small text-secondary text-center",children:"Applies to the current frame"}),Object(E.jsx)("ul",{className:"list-group list-group-flush",children:Object.entries(t.agents).map((function(e){var a,n,c=Object(l.a)(e,2),r=c[0],s=c[1];return Object(E.jsx)(te,{state:t,agentId:r,agent:s,label:null===(a=t.frames)||void 0===a||null===(n=a[t.activeFrame])||void 0===n?void 0:n[r]},r)}))}),0===Object.keys(t.agents).length&&Object(E.jsx)("p",{className:"text-center mx-2",children:"Use the dropdown and button below to add the agent that are present in this video"})]})}function ne(e){var t=e.state,a=e.sample;return Object(E.jsxs)(O.a,{md:4,lg:3,xl:2,className:"bg-light h-100 border-end border-dark d-flex flex-column gx-0",children:[Object(E.jsx)(ae,{state:t}),Object(E.jsx)($,{state:t,sample:a})]})}var ce=a(8);function re(e,t,a){var n,c,r,s;if(!t)return e;"function"===typeof a&&(a=a(null!==(r=null===(s=e.frames[e.activeFrame])||void 0===s?void 0:s[t])&&void 0!==r?r:{}));return Object(i.a)(Object(i.a)({},e),{},{frames:Object(i.a)(Object(i.a)({},e.frames),{},Object(ce.a)({},e.activeFrame,Object(i.a)(Object(i.a)({},e.frames[e.activeFrame]),{},Object(ce.a)({},t,Object(i.a)(Object(i.a)({},null!==(n=null===(c=e.frames[e.activeFrame])||void 0===c?void 0:c[t])&&void 0!==n?n:{}),a)))))})}function se(e,t){return t-=1,t=Math.max(0,Math.min(t,e.numFrames-1)),t=Math.round(t/e.sampleRate)*e.sampleRate,t+=1}function ie(e,t){var a;if(!e.settings&&"set_state"!==t.type)return console.warn("Received",t.type,"action before initial state from server"),e;switch(t.type){case"set_state":return t.state;case"set_loading_finished":return Object(i.a)(Object(i.a)({},e),{},{loading:!1});case"set_saving":return Object(i.a)(Object(i.a)({},e),{},{saving:t.value});case"set_active_agent":return Object(i.a)(Object(i.a)({},e),{},{activeAgent:t.activeAgent});case"set_agent_present":return Object(i.a)(Object(i.a)({},e),{},{agentPresent:Object(i.a)(Object(i.a)({},e.agentPresent),{},Object(ce.a)({},t.agent,t.isPresent))});case"set_agent_flipped":return Object(i.a)(Object(i.a)({},e),{},{agentFlipped:Object(i.a)(Object(i.a)({},e.agentFlipped),{},Object(ce.a)({},t.agent,t.isFlipped))});case"active_agent_toggle_present":return Object(i.a)(Object(i.a)({},e),{},{agentPresent:Object(i.a)(Object(i.a)({},e.agentPresent),{},Object(ce.a)({},e.activeAgent,!e.agentPresent[e.activeAgent]))});case"set_agent_position":return re(e,t.agentId,{x:t.x,y:t.y});case"rotate_agent":return re(e,t.agentId,(function(e){return{angle:(a=(e.angle||0)+t.by,a%(2*Math.PI))};var a}));case"rotate_active_agent":return ie(e,{type:"rotate_agent",agentId:e.activeAgent,by:t.by});case"move_agent":return re(e,t.agentId,(function(e){return{x:(e.x||0)+(t.x||0),y:(e.y||0)+(t.y||0)}}));case"move_active_agent":return ie(e,{type:"move_agent",agentId:e.activeAgent,x:t.x,y:t.y});case"next_frame":if(e.loading)return e;var n=e.activeFrame,c=se(e.settings,e.activeFrame+e.settings.sampleRate);return Object(i.a)(Object(i.a)({},e),{},{loading:!0,activeFrame:c,frames:Object(i.a)(Object(i.a)({},e.frames),{},Object(ce.a)({},c,null!==(a=e.frames[c])&&void 0!==a?a:e.frames[n]))});case"previous_frame":return Object(i.a)(Object(i.a)({},e),{},{loading:!0,activeFrame:se(e.settings,e.activeFrame-e.settings.sampleRate)});case"jump_to_frame":return Object(i.a)(Object(i.a)({},e),{},{loading:!0,activeFrame:se(e.settings,t.frame)});case"set_agent_is_blurred":return re(e,t.agentId,{isBlurred:t.isBlurred});case"toggle_active_agent_is_blurred":return re(e,e.activeAgent,(function(e){return{isBlurred:!e.isBlurred}}));case"set_agent_is_obscured":return re(e,t.agentId,{isObscured:t.isObscured});case"toggle_active_agent_is_obscured":return re(e,e.activeAgent,(function(e){return{isObscured:!e.isObscured}}));case"step_advance":return ie(e,function(e){var t=Object.keys(e.agents).sort(),a=t.indexOf(e.activeAgent);return!e.activeAgent||a<0?t.length>0?{type:"set_active_agent",activeAgent:t[0]}:{type:"next_frame"}:a+1<t.length?{type:"set_active_agent",activeAgent:t[a+1]}:{type:"advance_frame_and_set_agent",activeAgent:t[0]}}(e));case"step_retreat":return ie(e,function(e){var t=Object.keys(e.agents).sort().reverse(),a=t.indexOf(e.activeAgent);return!e.activeAgent||a<0?t.length>0?{type:"set_active_agent",activeAgent:t[0]}:{type:"previous_frame"}:a+1<t.length?{type:"set_active_agent",activeAgent:t[a+1]}:{type:"retreat_frame_and_set_agent",activeAgent:t[0]}}(e));case"advance_frame_and_set_agent":return e.loading?e:ie(ie(e,{type:"next_frame"}),{type:"set_active_agent",activeAgent:t.activeAgent});case"retreat_frame_and_set_agent":return e.loading?e:ie(ie(e,{type:"previous_frame"}),{type:"set_active_agent",activeAgent:t.activeAgent});case"set_dish_mask_position":return Object(i.a)(Object(i.a)({},e),{},{dishMask:Object(i.a)(Object(i.a)({},e.dishMask),{},{x:t.x,y:t.y})});case"set_dish_mask_radius":return Object(i.a)(Object(i.a)({},e),{},{dishMask:Object(i.a)(Object(i.a)({},e.dishMask),{},{radius:t.radius})});case"reset_dish_mask":return Object(i.a)(Object(i.a)({},e),{},{dishMask:null});case"set_dish_mask_locked":return Object(i.a)(Object(i.a)({},e),{},{dishMask:Object(i.a)(Object(i.a)({},e.dishMask),{},{locked:t.value})});case"add_agent":return Object(i.a)(Object(i.a)({},e),{},{agents:Object(i.a)(Object(i.a)({},e.agents),{},Object(ce.a)({},e.nextAgentId,t.agent)),nextAgentId:e.nextAgentId+1});case"set_agent_color":return Object(i.a)(Object(i.a)({},e),{},{agents:Object.fromEntries(Object.entries(e.agents).map((function(e){var a=Object(l.a)(e,2),n=a[0],c=a[1];return[n,n===t.agent?Object(i.a)(Object(i.a)({},c),{},{color:t.color}):c]})))});case"delete_agent":return Object(i.a)(Object(i.a)({},e),{},{agents:Object.fromEntries(Object.entries(e.agents).filter((function(e){var a=Object(l.a)(e,2),n=a[0];a[1];return n!==t.agent})))});case"set_agent_shape":return Object(i.a)(Object(i.a)({},e),{},{agents:Object.fromEntries(Object.entries(e.agents).map((function(e){var a=Object(l.a)(e,2),n=a[0],c=a[1];return[n,n===t.agent?Object(i.a)(Object(i.a)({},c),{},{shape:c.shape.map((function(e,a){return a===t.i||0===a&&t.i===c.shape.length-1||a===c.shape.length-1&&0===t.i?[t.shapeX,t.shapeY]:e}))}):c]})))});case"set_agent_display_name":return Object(i.a)(Object(i.a)({},e),{},{agents:Object.fromEntries(Object.entries(e.agents).map((function(e){var a=Object(l.a)(e,2),n=a[0],c=a[1];return[n,n===t.agent?Object(i.a)(Object(i.a)({},c),{},{display_name:t.display_name}):c]})))});case"set_modal":return Object(i.a)(Object(i.a)({},e),{},{modal:t.value});default:throw new Error("Unknown reducer action")}}var le={settings:null,loading:!0,saving:!1,modal:!1,activeFrame:1,activeAgent:null,agentPresent:{},agents:{},nextAgentId:0,frames:{}},oe=Symbol("NO_MATCH");function ue(){var e=Object(n.useReducer)(ie,le,(function(e){return e})),t=Object(l.a)(e,2),a=t[0],c=t[1],r=Object(n.useState)(null),s=Object(l.a)(r,2),b=s[0],h=s[1],v=Object(n.useState)(null),g=Object(l.a)(v,2),m=g[0],f=g[1],O=Object(n.useState)(null),p=Object(l.a)(O,2),y=p[0],_=p[1],k=Object(n.useState)(0),w=Object(l.a)(k,2),C=w[0],N=w[1],A=Object(n.useState)([!1]),S=Object(l.a)(A,2),F=S[0],I=S[1],T=Object(n.useMemo)((function(){return new URL(window.location).searchParams.get("experiment_id")}),[]);Object(n.useEffect)((function(){var e=new AbortController,t=e.signal;return fetch("".concat(M,"/api/experiment?id=").concat(T),{signal:t}).then((function(e){return e.json()})).then((function(e){if(t.aborted)console.log("State restoration aborted after fetch finished");else{h(e);var a=Object(i.a)(Object(i.a)({},le),e.label);delete e.label,a.settings=e,c({type:"set_state",state:a})}})).catch((function(e){"AbortError"!==e.name&&alert("Failed to fetch experiment: ".concat(e))})),function(){return e.abort()}}),[T]),Object(n.useEffect)((function(){function e(e){var t=function(){switch(e.key){case" ":return c({type:"step_advance"});case"b":return c({type:"step_retreat"});case"r":return c({type:"toggle_active_agent_is_blurred"});case"f":return c({type:"toggle_active_agent_is_obscured"});case"q":return c({type:"rotate_active_agent",by:.01});case"Q":return c({type:"rotate_active_agent",by:.1});case"e":return c({type:"rotate_active_agent",by:-.01});case"E":return c({type:"rotate_active_agent",by:-.1});case"w":return c({type:"move_active_agent",y:-1});case"W":return c({type:"move_active_agent",y:-10});case"a":return c({type:"move_active_agent",x:-1});case"A":return c({type:"move_active_agent",x:-10});case"s":return c({type:"move_active_agent",y:1});case"S":return c({type:"move_active_agent",y:10});case"d":return c({type:"move_active_agent",x:1});case"D":return c({type:"move_active_agent",x:10})}return oe}();return t!==oe&&e.preventDefault(),t}if(!a.modal)return document.addEventListener("keypress",e),function(){return document.removeEventListener("keypress",e)}}),[a.modal]);var P=!!b;return Object(n.useEffect)((function(){if(P&&a.settings){c({type:"set_saving",value:!0});var e=Object.fromEntries(["activeFrame","activeAgent","agentPresent","agents","frames","nextAgentId","dishMask"].map((function(e){return[e,a[e]]})));fetch("".concat(M,"/api/set_label?id=").concat(T),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then((function(e){switch(e.status){case 200:F[0]&&(I((function(e){return e[0]=!1,e})),_("Saved"),f(null));break;case 401:f("Save failed because you are unauthorized. Try making sure you are logged in at "+window.location.origin+" using a new tab and check that you are assigned to this experiment. If you close this tab, your changes may be lost.");break;default:f("Save failed! ".concat(e.statusText,". If you close this window, your ")+"progress will be lost")}}),(function(e){"Failed to fetch"===e.message?f("Save failed: Could not connect to server. Check that you are connected to the Internet and then contact your administrator. If you close this tab, your changes will be lost."):f("Save failed! ".concat(e.message,". If you close this window, your ")+"progress will be lost")})).then((function(){c({type:"set_saving",value:!1})}))}}),[P,a.activeFrame,T,C,F]),b?Object(E.jsxs)(E.Fragment,{children:[Object(E.jsx)(o.a,{fluid:!0,className:"h-100",children:Object(E.jsx)(u.a,{className:"h-100",children:Object(E.jsxs)(x.Provider,{value:c,children:[Object(E.jsx)(ne,{state:a,sample:b}),Object(E.jsx)(V,{sample:b,state:a,returnToIndex:function(){window.location="".concat(M,"/")},save:function(){I((function(e){return e[0]=!0,e})),N((function(e){return e+1}))}})]})})}),Object(E.jsxs)(d.a,{position:"bottom-end",className:"p-3",children:[Object(E.jsxs)(j.a,{onClose:function(){return f(null)},show:null!==m,children:[Object(E.jsx)(j.a.Header,{children:Object(E.jsx)("strong",{children:"Save error"})}),Object(E.jsx)(j.a.Body,{children:m})]}),Object(E.jsxs)(j.a,{onClose:function(){return _(null)},show:null!==y,delay:3e3,autohide:!0,children:[Object(E.jsx)(j.a.Header,{children:Object(E.jsx)("strong",{children:"Saved!"})}),Object(E.jsx)(j.a.Body,{children:y})]})]})]}):Object(E.jsx)("p",{children:"Loading\u2026"})}a(122),a(123);var de=function(){return Object(E.jsx)("div",{className:"App",children:Object(E.jsx)(ue,{})})},je=function(e){e&&e instanceof Function&&a.e(3).then(a.bind(null,143)).then((function(t){var a=t.getCLS,n=t.getFID,c=t.getFCP,r=t.getLCP,s=t.getTTFB;a(e),n(e),c(e),r(e),s(e)}))};s.a.render(Object(E.jsx)(c.a.StrictMode,{children:Object(E.jsx)(de,{})}),document.getElementById("root")),je()},79:function(e){e.exports=JSON.parse('[{"name":"gripper","display_name":"Gripper 1","shape":[[-143.92413189141612,51.84335246093342],[-48.072342656447375,79.81538314258269],[45.72914296233611,47.88919803209455],[143.44817449766214,86.51549575525146],[147.47556283000537,22.736344434302506],[96.40098497990128,-5.199072108746524],[137.55354949126553,-24.237623370279092],[147.47556658087464,-86.51565783567874],[62.49771702868982,-29.949191749434274],[-83.73301142993273,-62.60763712671145],[-147.47555142543342,-29.47323514143342],[-46.4247729973664,4.0639111158393595],[-143.92413189141612,51.84335246093342]]},{"name":"hammer","display_name":"Hammer 1","symmetrical":true,"shape":[[-113.63075292686482,-9.350874622148904],[-116.24090468580708,3.186553654626621],[-99.65774142852855,9.350861919342712],[81.90005536895531,6.949524366319025],[116.24095042089394,-9.35087216357365],[-113.63075292686482,-9.350874622148904]]},{"name":"needle","display_name":"Needle","symmetrical":true,"shape":[[122.86275165514863,4.463351744530263],[124.32539849455918,-3.465120001220135],[-114.05223857267488,-4.463450383742782],[-124.3255881557796,-0.05229539402387677],[-115.5729269962321,4.463335528244747],[122.86275165514863,4.463351744530263]]},{"name":"pillcam","display_name":"Pillcam","symmetrical":true,"shape":[[4.585514267115303,-185.38631589799516],[30.79716156694573,-179.30770208979084],[58.632807234519504,-149.96188756251487],[66.15328787764503,-123.49601574811257],[60.67797622200067,118.25596658558737],[50.907420517050994,153.14917855033025],[17.137347004772277,181.6374592105472],[-14.405418787275961,185.38631586131314],[-44.38110096560142,172.17804277419],[-66.15331105269996,141.03368746021306],[-66.15330385277282,-122.5132723021791],[-50.81258336876257,-156.41994266409267],[-19.9945455511072,-180.40428224369262],[4.585514267115303,-185.38631589799516]]},{"name":"gripper 2","display_name":"Gripper 2","shape":[[17.235294117647054,95.35294117647058],[12.235294117647054,95.35294117647058],[-3.7647058823529447,40.35294117647058],[-13.764705882352946,38.35294117647058],[-44.76470588235294,89.35294117647058],[-57.76470588235294,86.35294117647058],[-36.76470588235294,-22.647058823529424],[-37.76470588235294,-52.64705882352942],[-54.76470588235294,-109.64705882352942],[-1.7647058823529445,-97.64705882352942],[8.235294117647054,-77.64705882352942],[15.235294117647054,-76.64705882352942],[30.235294117647054,-91.64705882352942],[83.23529411764706,-74.64705882352942],[48.23529411764706,-32.64705882352942],[19.235294117647054,95.35294117647058],[17.235294117647054,95.35294117647058]]},{"name":"hammer2","display_name":"Hammer 2","symmetrical":true,"shape":[[140.33333333333334,102.66666666666667],[-144.66666666666666,-88.33333333333333],[-149.66666666666666,-104.33333333333333],[-132.66666666666666,-103.33333333333333],[146.33333333333334,90.66666666666667],[140.33333333333334,102.66666666666667]]},{"name":"needle tip","display_name":"Needle Tip","symmetrical":true,"shape":[[40,34.64],[-40,69.33],[0,-34.64],[40,34.64]]},{"name":"needle body","display_name":"Needle Body","symmetrical":true,"shape":[[120,-30],[120,30],[-120,-30],[-120,30],[120,-30]]}]')}},[[124,1,2]]]);
//# sourceMappingURL=main.d9574d31.chunk.js.map
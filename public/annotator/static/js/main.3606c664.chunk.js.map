{"version":3,"sources":["components/labels.js","components/util.js","components/Timeline.js","components/Toolbar.js","components/VideoLabeler.js","components/Sidebar.js","reducer.js","components/Labeler.js","App.js","reportWebVitals.js","index.js"],"names":["LabelsDispatch","createContext","apiBaseUrl","getSrcForFrame","sampleId","activeFrame","getComponentType","state","i","frames","UpdatingPopover","forwardRef","ref","popper","children","props","show","useEffect","scheduleUpdate","Popover","body","Timeline","sample","dispatch","useContext","components","useMemo","lastComponentType","componentLength","numFrames","componentType","push","useState","hoverPositionPercent","setHoverPositionPercent","wantsToNavigateToFrame","setWantsToNavigateToFrame","hoverPositionFrame","Math","min","floor","Modal","onHide","Header","closeButton","Title","Body","Footer","Button","onClick","variant","type","frame","className","onMouseMove","event","bounds","currentTarget","getBoundingClientRect","pct","clientX","x","width","max","preventDefault","onMouseLeave","OverlayTrigger","placement","overlay","src","id","alt","height","style","left","map","flexGrow","Toolbar","returnToIndex","helpVisible","setHelpVisible","Navbar","Nav","Text","Spinner","animation","size","loading","sampleRate","ButtonGroup","disabled","Dropdown","Toggle","dishMask","locked","verticalAlign","Menu","Item","value","Card","border","transform","y","angle","flipped","matrix","DOMMatrix","cos","sin","multiplySelf","DISH_MASK","Symbol","VideoLabeler","preloadCanvas","setPreloadCanvas","image","setImage","element","document","createElement","imageLoaded","addEventListener","removeEventListener","dishMaskLocation","naturalWidth","naturalHeight","radius","canvas","setCanvas","getContext","save","ctx","restore","fillStyle","fillRect","beginPath","arc","PI","clip","getAgentLocation","useCallback","agentId","Error","console","assert","agentLabel","eventToImageCoordinates","nativeEvent","offsetX","clientHeight","offsetY","clientWidth","setTransform","drawImage","lineWidth","Object","entries","agents","agent","color_convert","hex","hsl","color","slice","h","s","l","activeAgent","strokeStyle","shape","shapeX","shapeY","lineTo","stroke","fill","activeAgentLabel","Image","drag","setDrag","startDrag","mouse","getHoveredAgent","agentPos","xTranslated","yTranslated","xRotated","yRotated","point_in_polygon","isDishMaskHovered","mouseX","mouseY","dishX","dishY","isDragging","Col","onMouseDown","hoveredAgent","onMouseUp","xDelta","yDelta","onWheel","agentToScroll","deltaY","shiftKey","by","PADDING","AgentEditModal","onClose","hoveredPoint","setHoveredPoint","draggingPoint","setDraggingPoint","NaN","top","bottom","right","setDimensions","agentTf","inverse","offsetTf","multiply","scale","length","eventToScaledAgentCoordinates","closest","dist","sqrt","pow","Form","Group","controlId","Label","Control","display_name","onChange","cursor","SidebarAgentsPresent","agentToAdd","setAgentToAdd","editingAgent","setEditingAgent","SidebarAgent","onColorChange","onClickEdit","_","onClickDelete","Select","e","name","agentName","existing_agent","find","hsv","random","addAgent","title","SidebarAgentAnnotation","label","FormCheck","checked","isBlurred","isObscured","SidebarAgentAnnotations","keys","Sidebar","md","lg","xl","updateFrame","changes","clampFrame","settings","frameNum","round","reducer","action","warn","agentPresent","isPresent","agentFlipped","isFlipped","prevActiveFrame","current","presentAgentIds","sort","idx","indexOf","stepAdvanceDispatch","reverse","stepRetreatDispatch","nextAgentId","fromEntries","filter","modal","defaultState","NO_MATCH","Labeler","useReducer","setSample","experimentId","URL","window","location","searchParams","get","controller","AbortController","signal","fetch","then","response","json","aborted","log","catch","err","alert","abort","listener","ret","key","hasSample","save_state","method","credentials","headers","JSON","stringify","Container","fluid","Row","Provider","App","reportWebVitals","onPerfEntry","Function","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","render","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.3606c664.chunk.js","sourcesContent":["import { createContext } from \"react\"\n\nexport const LabelsDispatch = createContext({})","// export const apiBaseUrl = ''\nexport const apiBaseUrl = '//127.0.0.1:8011'\n\nexport function getSrcForFrame(sampleId, activeFrame) {\n    if (!sampleId) return \"\"\n    return `${apiBaseUrl}/api/frame.jpg?experiment=${sampleId}&frame=${activeFrame}`\n}","import { forwardRef, useContext, useEffect, useMemo, useState } from \"react\"\n\nimport \"./Timeline.css\"\nimport { Button, Modal, OverlayTrigger, Popover } from \"react-bootstrap\"\nimport { getSrcForFrame } from \"./util\"\nimport { LabelsDispatch } from \"./labels\"\n\nfunction getComponentType(state, i) {\n    if (i === state.activeFrame) return 'active'\n    return state.frames?.[i] ? 'labeled' : 'unlabeled'\n}\n\n// The shell of this component is copied straight from react-bootstrap documentation\nconst UpdatingPopover = forwardRef(\n    ({ popper, children, show: _, ...props }, ref) => {\n        useEffect(() => {\n            popper.scheduleUpdate()\n        }, [children, popper])\n\n        return (\n            <Popover ref={ref} body {...props}>\n                {children}\n            </Popover>\n        )\n    },\n)\n\n\nexport function Timeline({ sample, state }) {\n    const dispatch = useContext(LabelsDispatch)\n\n    const components = useMemo(() => {\n        const components = []\n        let lastComponentType = null\n        let componentLength = 0\n        for (let i = 1; i <= sample.numFrames; i++) {\n            const componentType = getComponentType(state, i)\n            if (componentType !== lastComponentType && lastComponentType !== null) {\n                components.push({ componentType: lastComponentType, componentLength })\n                componentLength = 0\n            }\n            componentLength += 1\n            lastComponentType = componentType\n        }\n\n        if (componentLength !== 0) {\n            components.push({ componentType: lastComponentType, componentLength })\n        }\n        return components\n    }, [sample.numFrames, state])\n\n    const [hoverPositionPercent, setHoverPositionPercent] = useState(null)\n    const [wantsToNavigateToFrame, setWantsToNavigateToFrame] = useState(null)\n\n    function onMouseMove(event) {\n        const bounds = event.currentTarget.getBoundingClientRect()\n        const pct = (event.clientX - bounds.x) / bounds.width\n\n        // Clamp to [0, 1]\n        setHoverPositionPercent(Math.max(0, Math.min(pct, 1)))\n        event.preventDefault()\n    }\n\n    function onMouseLeave() {\n        setHoverPositionPercent(null)\n    }\n\n    // This floor operation could return the `sample.numFrames`th frame, which doesn't exist\n    const hoverPositionFrame = hoverPositionPercent === null ? null :\n        Math.min(Math.floor(hoverPositionPercent * sample.numFrames), sample.numFrames - 1)\n\n    function onClick() {\n        setWantsToNavigateToFrame(hoverPositionFrame)\n    }\n\n    // This noinspection is because WebStorm thinks all arguments to OverlayTrigger are required, but most are optional\n    // noinspection RequiredAttributes\n    return (<>\n        <Modal show={wantsToNavigateToFrame !== null} onHide={() => setWantsToNavigateToFrame(null)}>\n            <Modal.Header closeButton>\n                <Modal.Title>Jump to frame {wantsToNavigateToFrame}?</Modal.Title>\n            </Modal.Header>\n            <Modal.Body>\n                <p>\n                    You will automatically start annotating at this position. Removing annotations is not yet supported,\n                    so be sure this is the frame you want.\n                </p>\n            </Modal.Body>\n            <Modal.Footer>\n                <Button onClick={() => setWantsToNavigateToFrame(null)} variant=\"secondary\">Cancel</Button>\n                <Button onClick={() => {\n                    dispatch({ type: 'jump_to_frame', frame: wantsToNavigateToFrame })\n                    setWantsToNavigateToFrame(null)\n                }}\n                        variant=\"primary\">Jump to frame</Button>\n            </Modal.Footer>\n        </Modal>\n\n        <div className=\"timeline\"\n                 onMouseMove={onMouseMove}\n                 onMouseLeave={onMouseLeave}\n                 onClick={onClick}>\n\n            {hoverPositionFrame !== null && <OverlayTrigger show={true} placement={'top'} overlay={\n                <UpdatingPopover className=\"p-0\">\n                    <img\n                        src={getSrcForFrame(sample.id, hoverPositionFrame)}\n                        alt={`Frame ${hoverPositionFrame}`}\n                        height={180}\n                    />\n                </UpdatingPopover>\n            }>\n                <div className=\"timeline-cursor\" style={{\n                    width: `min(2px, ${100 / sample.numFrames}%)`,\n                    left: `${100 * hoverPositionFrame / sample.numFrames}%`,\n                }} />\n            </OverlayTrigger>}\n            {components.map(({ componentType, componentLength }, i) => (\n                <div key={i}\n                     className={`timeline-component timeline-component-${componentType}`}\n                     style={{ flexGrow: componentLength }} />\n            ))}\n        </div>\n    </>)\n}","import { useContext, useState } from \"react\"\nimport { LabelsDispatch } from \"./labels\"\nimport { Button, ButtonGroup, Card, Dropdown, Nav, Navbar, Spinner } from \"react-bootstrap\"\nimport { AiFillStepForward, AiFillStepBackward } from \"react-icons/ai\"\nimport { BiHelpCircle } from \"react-icons/bi\"\nimport { CgCloseR } from \"react-icons/cg\"\nimport { ImLock, ImUnlocked } from \"react-icons/im\"\n\nexport function Toolbar({ sample, state, returnToIndex }) {\n    const dispatch = useContext(LabelsDispatch)\n\n    const [helpVisible, setHelpVisible] = useState(false)\n    return (<>\n        <Navbar className=\"d-flex justify-content-between\">\n            {/* Left */}\n            <Nav>\n                <Navbar.Text>\n                    <Spinner animation=\"border\" size=\"sm\" className={`me-2 ${state.loading ? 'visible' : 'invisible'}`} />\n                    Frame {state.activeFrame} of {sample.numFrames} (sampling every {sample.sampleRate} frames)\n                </Navbar.Text>\n            </Nav>\n\n            {/* Center */}\n            <Nav>\n                <ButtonGroup>\n                    <Button\n                        onClick={() => dispatch({ type: 'previous_frame' })}\n                        disabled={state.activeFrame <= 1}\n                    ><AiFillStepBackward /></Button>\n                    <Button\n                        onClick={() => dispatch({ type: 'next_frame' })}\n                        disabled={state.activeFrame + sample.sampleRate > sample.numFrames}\n                    ><AiFillStepForward /></Button>\n                </ButtonGroup>\n            </Nav>\n\n            {/* Right */}\n            <Nav>\n                <Dropdown>\n                    <Dropdown.Toggle>\n                        {state.dishMask?.locked ?\n                            <ImLock style={{ verticalAlign: \"text-top\" }} /> :\n                            <ImUnlocked style={{ verticalAlign: \"text-top\" }} />} Dish mask\n                    </Dropdown.Toggle>\n\n                    <Dropdown.Menu>\n                        {state.dishMask?.locked && <Dropdown.Item\n                            onClick={() => dispatch({ type: 'set_dish_mask_locked', value: false })}\n                        >Unlock</Dropdown.Item>}\n                        {!state.dishMask?.locked && <Dropdown.Item\n                            onClick={() => dispatch({ type: 'set_dish_mask_locked', value: true })}\n                        >Lock</Dropdown.Item>}\n\n                        <Dropdown.Item onClick={() => dispatch({ type: 'reset_dish_mask' })}>Reset to center</Dropdown.Item>\n                    </Dropdown.Menu>\n                </Dropdown>\n\n                <Button\n                    className=\"mx-2\"\n                    variant={helpVisible ? \"info\" : \"outline-info\"}\n                    onClick={() => setHelpVisible(!helpVisible)}\n                ><BiHelpCircle /></Button>\n\n                <Button onClick={returnToIndex}>Stop labeling</Button>\n            </Nav>\n        </Navbar>\n\n        {helpVisible && <Card border=\"info\" className=\"mb-2\">\n            <Card.Header>\n                <button className=\"float-end border-0\" onClick={() => setHelpVisible(!helpVisible)}>\n                    <CgCloseR />\n                </button>\n                Help\n            </Card.Header>\n            <Card.Body className=\"row\">\n                <dl className=\"col mb-0\">\n                    <dt>Space</dt>\n                    <dd>Advance through agents and frames</dd>\n                    <dt>b</dt>\n                    <dd>Reverse through agents and frames</dd>\n                </dl>\n                <dl className=\"col mb-0\">\n                    <dt>q/e/scroll</dt>\n                    <dd>Rotate selected agent</dd>\n                    <dt>w/a/s/d/drag</dt>\n                    <dd>Move selected agent</dd>\n                </dl>\n                <dl className=\"col mb-0\">\n                    <dt>Shift</dt>\n                    <dd>Rotate/move by 10x</dd>\n                </dl>\n            </Card.Body>\n        </Card>}\n    </>)\n}","import { useCallback, useContext, useEffect, useMemo, useState } from \"react\"\nimport { Col } from \"react-bootstrap\"\nimport point_in_polygon from \"robust-point-in-polygon\"\n\nimport './VideoLabeler.css'\nimport { LabelsDispatch } from \"./labels\"\nimport { Timeline } from \"./Timeline\"\nimport { Toolbar } from \"./Toolbar\"\nimport { getSrcForFrame } from \"./util\"\nimport color_convert from \"color-convert\"\n\nexport function transform(x, y, angle, flipped) {\n    const matrix = new DOMMatrix([\n        Math.cos(angle), -Math.sin(angle),\n        Math.sin(angle), Math.cos(angle),\n        x, y\n    ])\n    if (flipped) {\n        matrix.multiplySelf(new DOMMatrix([\n            1, 0,\n            0, -1,\n            0, 0,\n        ]))\n    }\n    return matrix\n}\n\nconst DISH_MASK = Symbol('DISH_MASK')\n\nexport function VideoLabeler({ sample, state, returnToIndex }) {\n    const dispatch = useContext(LabelsDispatch)\n\n    /** @type {React.MutableRefObject<HTMLCanvasElement>} */\n    const [preloadCanvas, setPreloadCanvas] = useState(null)\n    const [image, setImage] = useState(null)\n    useEffect(() => {\n        const element = document.createElement('img')\n\n        function imageLoaded() {\n            setImage(element)\n            dispatch({ type: 'set_loading_finished' })\n        }\n\n        element.addEventListener('load', imageLoaded)\n        element.src = getSrcForFrame(sample.id, state.activeFrame)\n\n        // The element will be garbage collected as long as this event listener isn't around creating a cycle\n        return () => element.removeEventListener('load', imageLoaded)\n    }, [dispatch, sample.id, state.activeFrame])\n\n    const dishMaskLocation = useMemo(() => {\n        if (!image) return null\n\n        const x = state.dishMask?.x ?? image.naturalWidth / 2\n        const y = state.dishMask?.y ?? image.naturalHeight / 2\n        const radius = state.dishMask?.radius ?? 500\n\n        return { x, y, radius }\n    }, [image, state])\n\n    const [canvas, setCanvas] = useState(null)\n    useEffect(() => {\n        if (preloadCanvas && image) {\n            preloadCanvas.width = image.naturalWidth\n            preloadCanvas.height = image.naturalHeight\n\n            preloadCanvas.getContext('2d').save()\n\n            setCanvas(preloadCanvas)\n        }\n    }, [preloadCanvas, image])\n\n    useEffect(() => {\n        if (!canvas) return\n        if (!dishMaskLocation) return\n\n        const ctx = canvas.getContext('2d')\n\n        ctx.restore()\n        ctx.save()\n\n        ctx.fillStyle = \"black\"\n        ctx.fillRect(0, 0, canvas.width, canvas.height)\n\n        ctx.beginPath()\n        const { x, y, radius } = dishMaskLocation\n        ctx.arc(x, y, radius, 0, Math.PI * 2)\n        ctx.clip()\n    }, [canvas, dishMaskLocation])\n\n\n    const getAgentLocation = useCallback(function (state, agentId) {\n        if (!canvas) throw new Error(\"Canvas ref was cleared\")\n\n        if (agentId === DISH_MASK) {\n            return dishMaskLocation\n        }\n\n        console.assert(typeof agentId === \"string\")\n\n        const agentLabel = state.frames[state.activeFrame]?.[agentId] ?? {}\n        const x = agentLabel.x ?? canvas.width / 2\n        const y = agentLabel.y ?? canvas.height / 2\n        const angle = agentLabel.angle ?? 0\n\n        return { x, y, angle }\n    }, [canvas, dishMaskLocation])\n\n    useEffect(() => {\n        if (!canvas) return\n        if (!image) return\n\n        const ctx = canvas.getContext('2d')\n        ctx.setTransform(1, 0, 0, 1, 0, 0)\n\n        ctx.drawImage(image, 0, 0)\n\n        ctx.lineWidth = 2\n\n        for (const [agentId, agent] of Object.entries(state.agents)) {\n            const [h, s, l] = color_convert.hex.hsl(agent.color.slice(1))\n            if (agentId === state.activeAgent) {\n                ctx.strokeStyle = `hsla(${h}, ${s}%, ${l}%, 1)`\n                ctx.fillStyle = `hsla(${h}, ${s}%, ${l}%, 0.2)`\n            } else {\n                ctx.strokeStyle = `hsla(${h}, ${s * 0.25}%, ${l}%, 1)`\n                ctx.fillStyle = `hsla(${h}, ${s * 0.25}%, ${l}%, 0.2)`\n            }\n            const { x, y, angle } = getAgentLocation(state, agentId)\n            const flipped = false // TODO remove \n\n            ctx.setTransform(transform(x, y, angle, flipped))\n            ctx.beginPath()\n            for (const [shapeX, shapeY] of agent.shape) {\n                ctx.lineTo(shapeX, shapeY)\n            }\n            ctx.stroke()\n            ctx.fill()\n        }\n    }, [canvas, getAgentLocation, image, state])\n\n    useEffect(() => {\n        const activeAgentLabel = state.frames[state.activeFrame]?.[state.activeAgent] ?? {}\n\n        if (dispatch && image && (\n            typeof activeAgentLabel.x === \"undefined\" ||\n            typeof activeAgentLabel.y === \"undefined\")\n        ) {\n            dispatch({\n                type: 'set_agent_position',\n                agentId: state.activeAgent,\n                x: activeAgentLabel.x ?? image.naturalWidth / 2,\n                y: activeAgentLabel.y ?? image.naturalHeight / 2,\n            })\n        }\n    }, [dispatch, state, image])\n\n    // Preload next 3 frames\n    useEffect(() => {\n        new Image().src = getSrcForFrame(sample.id, state.activeFrame + 1)\n        new Image().src = getSrcForFrame(sample.id, state.activeFrame + 2)\n        new Image().src = getSrcForFrame(sample.id, state.activeFrame + 3)\n    }, [sample.id, state.activeFrame])\n\n    function eventToImageCoordinates(event) {\n        if (!canvas) throw new Error(\"Canvas ref was cleared\")\n\n        const x = event.nativeEvent.offsetX * (canvas.height / canvas.clientHeight)\n        const y = event.nativeEvent.offsetY * (canvas.width / canvas.clientWidth)\n\n        return { x, y }\n    }\n\n    const [drag, setDrag] = useState(null)\n\n    function startDrag(x, y, agentId) {\n        if (!agentId) return\n\n        setDrag({\n            agentId,\n            mouse: { x, y },\n            agent: getAgentLocation(state, agentId)\n        })\n    }\n\n    function endDrag() {\n        setDrag(null)\n    }\n\n    function getHoveredAgent(x, y) {\n        for (const [agentId, agent] of Object.entries(state.agents)) {\n            const agentPos = getAgentLocation(state, agentId)\n            const xTranslated = x - agentPos.x\n            const yTranslated = y - agentPos.y\n            const xRotated = xTranslated * Math.cos(-agentPos.angle) + yTranslated * Math.sin(-agentPos.angle)\n            const yRotated = -xTranslated * Math.sin(-agentPos.angle) + yTranslated * Math.cos(-agentPos.angle)\n\n            if (point_in_polygon(agent.shape, [xRotated, yRotated]) <= 0) {\n                return agentId\n            }\n        }\n\n        return null\n    }\n\n    function isDishMaskHovered(mouseX, mouseY) {\n        if (state.dishMask?.locked) return false\n        const { x: dishX, y: dishY, radius } = dishMaskLocation\n        const dist_sqr = (mouseX - dishX) ** 2 + (mouseY - dishY) ** 2\n        return dist_sqr > radius ** 2\n    }\n\n    function onCanvasMousedown(event) {\n        const { x, y } = eventToImageCoordinates(event)\n        if (isDishMaskHovered(x, y)) {\n            startDrag(x, y, DISH_MASK)\n            return\n        }\n\n        const hoveredAgent = getHoveredAgent(x, y)\n        if (hoveredAgent) {\n            dispatch({\n                type: 'set_active_agent',\n                activeAgent: hoveredAgent\n            })\n        }\n        startDrag(x, y, hoveredAgent ?? state.activeAgent)\n    }\n\n    function isDragging() {\n        return drag && (drag.agentId === state.activeAgent || drag.agentId === DISH_MASK)\n    }\n\n    function onCanvasMousemove(event) {\n        if (isDragging()) {\n            const xDelta = event.nativeEvent.offsetX * (canvas.height / canvas.clientHeight) - drag.mouse.x\n            const yDelta = event.nativeEvent.offsetY * (canvas.width / canvas.clientWidth) - drag.mouse.y\n\n            if (drag.agentId === DISH_MASK) {\n                dispatch({\n                    type: 'set_dish_mask_position',\n                    x: xDelta + drag.agent.x,\n                    y: yDelta + drag.agent.y,\n                })\n            } else {\n                dispatch({\n                    type: 'set_agent_position',\n                    agentId: drag.agentId,\n                    x: xDelta + drag.agent.x,\n                    y: yDelta + drag.agent.y,\n                })\n            }\n        }\n    }\n\n    function agentToScroll(x, y) {\n        // If dragging, rotate the agent being dragged. Otherwise, rotate the hovered agent (or dish). Otherwise,\n        // scroll the selected agent\n\n        if (isDragging()) return drag.agentId\n\n        if (isDishMaskHovered(x, y)) return DISH_MASK\n\n        return getHoveredAgent(x, y) ?? state.activeAgent\n    }\n\n    function onCanvasWheel(event) {\n        const { x, y } = eventToImageCoordinates(event)\n\n        const agentId = agentToScroll(x, y)\n\n        if (agentId === DISH_MASK) {\n            const { radius } = dishMaskLocation\n            dispatch({\n                type: 'set_dish_mask_radius',\n                radius: Math.max(10, radius + event.deltaY / (event.shiftKey ? 10 : 100)),\n            })\n        } else if (agentId) {\n            if (agentId !== state.activeAgent) {\n                dispatch({\n                    type: 'set_active_agent',\n                    activeAgent: agentId\n                })\n            }\n\n            dispatch({\n                type: 'rotate_agent',\n                agentId,\n                by: event.deltaY / (event.shiftKey ? 1000 : 10000),\n            })\n        }\n    }\n\n    return (<Col className=\"h-100 d-flex flex-column\">\n        <Toolbar sample={sample} state={state} returnToIndex={returnToIndex} />\n        <div className=\"labeler-canvas-container\">\n            <canvas\n                className=\"labeler-canvas\"\n                ref={setPreloadCanvas}\n                onMouseDown={onCanvasMousedown}\n                onMouseUp={endDrag}\n                onMouseMove={onCanvasMousemove}\n                onWheel={onCanvasWheel}\n            />\n            <Timeline sample={sample} state={state} />\n        </div>\n    </Col>)\n}","import { Button, Col, Form, FormCheck, Modal } from \"react-bootstrap\"\n\nimport agents from \"../agents.json\"\nimport { useCallback, useContext, useEffect, useMemo, useState } from \"react\"\nimport { LabelsDispatch } from \"./labels\"\nimport color_convert from \"color-convert\"\nimport { BsPencilSquare } from \"react-icons/bs\"\nimport { RiDeleteBack2Fill } from \"react-icons/ri\"\n\nimport \"./Sidebar.css\"\nimport { getSrcForFrame } from \"./util\"\nimport { transform } from \"./VideoLabeler\"\n\nconst SCALE_FACTOR = 5\nconst PADDING = 100\n\nfunction AgentEditModal({ state, sample, agent: agentId, onClose }) {\n    const dispatch = useContext(LabelsDispatch)\n    const agent = agentId === null ? null : state.agents[agentId]\n\n    const [image, setImage] = useState(null)\n    const [preloadCanvas, setPreloadCanvas] = useState(null)\n    const [canvas, setCanvas] = useState(null)\n    const [hoveredPoint, setHoveredPoint] = useState(null)\n    const [draggingPoint, setDraggingPoint] = useState(null)\n\n    useEffect(() => {\n        dispatch({\n            type: 'set_modal',\n            value: agent !== null\n        })\n    }, [agent])\n\n    // Much of this is copied almost directly from VideoLabeler\n    useEffect(() => {\n        const element = document.createElement('img')\n\n        function imageLoaded() {\n            setImage(element)\n        }\n\n        element.addEventListener('load', imageLoaded)\n        element.src = getSrcForFrame(sample.id, state.activeFrame)\n\n        // The element will be garbage collected as long as this event listener isn't around creating a cycle\n        return () => element.removeEventListener('load', imageLoaded)\n    }, [sample.id, state.activeFrame])\n\n    // Remember bounds while dragging\n    const [[top, bottom, left, right], setDimensions] = useState([NaN, NaN, NaN, NaN])\n    useEffect(() => {\n        if (!agent) {\n            setDimensions([NaN, NaN, NaN, NaN])\n        } else if (draggingPoint === null) {\n            const top = Math.min(...agent.shape.map(([_, y]) => y))\n            const bottom = Math.max(...agent.shape.map(([_, y]) => y))\n            const left = Math.min(...agent.shape.map(([x, _]) => x))\n            const right = Math.max(...agent.shape.map(([x, _]) => x))\n            setDimensions([top, bottom, left, right])\n        }\n    }, [agent, draggingPoint])\n\n    useEffect(() => {\n        if (preloadCanvas && image) {\n            preloadCanvas.width = image.naturalWidth\n            preloadCanvas.height = image.naturalHeight\n\n            preloadCanvas.getContext('2d').save()\n\n            setCanvas(preloadCanvas)\n        }\n    }, [preloadCanvas, image])\n\n    useEffect(() => {\n        if (!canvas) return\n        canvas.width = (right - left) * SCALE_FACTOR + PADDING\n        canvas.height = (bottom - top) * SCALE_FACTOR + PADDING\n    }, [canvas, top, bottom, left, right, draggingPoint])\n\n    const getAgentLocation = useCallback(function (state, agentId) {\n        if (!canvas) throw new Error(\"Canvas ref was cleared\")\n\n        const agentLabel = state.frames[state.activeFrame]?.[agentId] ?? {}\n        const x = agentLabel.x ?? canvas.width / 2\n        const y = agentLabel.y ?? canvas.height / 2\n        const angle = agentLabel.angle ?? 0\n\n        return { x, y, angle }\n    }, [canvas])\n    useEffect(() => {\n        if (!agent) return\n        if (!canvas) return\n        if (!image) return\n\n        const ctx = canvas.getContext('2d')\n\n        const { x, y, angle } = getAgentLocation(state, agentId)\n        const agentTf = transform(x * SCALE_FACTOR, y * SCALE_FACTOR, angle, false).inverse()\n        const offsetTf = transform(canvas.width / 2, canvas.height / 2, 0, false)\n        ctx.setTransform(offsetTf.multiply(agentTf))\n        ctx.scale(SCALE_FACTOR, SCALE_FACTOR)\n\n        ctx.drawImage(image, 0, 0)\n\n        ctx.scale(1, 1)\n        ctx.lineWidth = 2\n\n        const [h, s, l] = color_convert.hex.hsl(agent.color.slice(1))\n\n        ctx.setTransform(1, 0, 0, 1, canvas.width / 2, canvas.height / 2)\n\n        // Draw lines and fill\n        ctx.strokeStyle = `hsla(${h}, ${s}%, ${l}%, 1)`\n        ctx.fillStyle = `hsla(${h}, ${s}%, ${l}%, 0.2)`\n        ctx.beginPath()\n        for (const [shapeX, shapeY] of agent.shape) {\n            ctx.lineTo(shapeX * SCALE_FACTOR, shapeY * SCALE_FACTOR)\n        }\n        ctx.stroke()\n        ctx.fill()\n\n        // Draw handles\n        ctx.fillStyle = `hsla(${h}, ${s}%, ${l * 0.5}%, 0.8)`\n        for (let i = 0; i < agent.shape.length; i++) {\n            const [shapeX, shapeY] = agent.shape[i]\n            ctx.beginPath()\n            if (i === hoveredPoint) {\n                ctx.strokeStyle = `#fff`\n                ctx.arc(shapeX * SCALE_FACTOR, shapeY * SCALE_FACTOR, 8, 0, 2 * Math.PI)\n            } else {\n                ctx.strokeStyle = `hsla(${h}, ${s}%, ${l * 0.5}%, 1)`\n                ctx.arc(shapeX * SCALE_FACTOR, shapeY * SCALE_FACTOR, 5, 0, 2 * Math.PI)\n            }\n            ctx.stroke()\n            ctx.fill()\n        }\n\n    }, [canvas, image, agentId, agent, getAgentLocation, state, hoveredPoint])\n\n    const eventToScaledAgentCoordinates = useCallback(function eventToScaledAgentCoordinates(event) {\n        if (!canvas) throw new Error(\"Canvas ref was cleared\")\n\n        const x = event.nativeEvent.offsetX * (canvas.width / canvas.clientWidth) - PADDING / 2 + left * SCALE_FACTOR\n        const y = event.nativeEvent.offsetY * (canvas.height / canvas.clientHeight) - PADDING / 2 + top * SCALE_FACTOR\n\n        return { x, y }\n    }, [canvas, left, top])\n\n    const onMouseMove = useCallback(function onMouseMove(event) {\n        const { x, y }  = eventToScaledAgentCoordinates(event)\n\n        if (draggingPoint !== null) {\n            dispatch({\n                type: \"set_agent_shape\",\n                agent: agentId,\n                i: draggingPoint,\n                shapeX: x / SCALE_FACTOR,\n                shapeY: y / SCALE_FACTOR,\n            })\n        } else {\n            // this could be written better if it wasn't so late at night\n            let closest = null\n            for (let i = 0; i < agent.shape.length; i++) {\n                const [shapeX, shapeY] = agent.shape[i]\n                const dist = Math.sqrt(Math.pow(shapeX * SCALE_FACTOR - x, 2) + Math.pow(shapeY * SCALE_FACTOR - y, 2))\n                if (closest === null || closest.dist > dist) {\n                    closest = { dist, i }\n                }\n            }\n            if (closest === null || closest.dist > 8) {\n                setHoveredPoint(null)\n            } else {\n                setHoveredPoint(closest.i)\n            }\n\n        }\n    }, [eventToScaledAgentCoordinates, agentId, agent, draggingPoint, dispatch])\n\n    function onChangeDisplayName(event) {\n        dispatch({\n            type: 'set_agent_display_name',\n            agent: agentId,\n            display_name: event.currentTarget.value\n        })\n    }\n\n    return (\n            <Modal show={agentId !== null} onHide={onClose} size=\"lg\">\n                <Modal.Header closeButton>\n                    <Modal.Title>Edit Agent</Modal.Title>\n                </Modal.Header>\n                <Modal.Body>\n                    <Form>\n                        {agent && <Form.Group className=\"mb-3\" controlId=\"agentName\">\n                            <Form.Label>Agent Name</Form.Label>\n                            <Form.Control type=\"text\" value={agent.display_name} onChange={onChangeDisplayName} />\n                        </Form.Group>}\n\n                        <Form.Group className=\"mb-3\" controlId=\"agentShape\">\n                            <Form.Label>Edit agent shape. This affects all frames of this video. If this frame doesn't give a clear view,\n                                you can advance to another frame and Edit again.</Form.Label>\n                        </Form.Group>\n                    </Form>\n\n                    <canvas\n                            style={{ cursor: hoveredPoint === null ? \"auto\" : \"grab\" }}\n                            className=\"agent-edit-canvas w-100\"\n                            ref={setPreloadCanvas}\n                            onMouseMove={onMouseMove}\n                            onMouseDown={() => { setDraggingPoint(hoveredPoint) }}\n                            onMouseUp={() => { setDraggingPoint(null) }}\n                    />\n                </Modal.Body>\n                <Modal.Footer>\n                    <Button variant=\"primary\" onClick={onClose}>\n                        Done\n                    </Button>\n                </Modal.Footer>\n            </Modal>\n    )\n}\n\nfunction SidebarAgentsPresent({ state, sample }) {\n    const dispatch = useContext(LabelsDispatch)\n    const [agentToAdd, setAgentToAdd] = useState(\"\")\n    const [editingAgent, setEditingAgent] = useState(null)\n    if (!dispatch) return null\n\n    function addAgent(agentName) {\n      const existing_agent = agents.find(agent => agent.name === agentName)\n      if (existing_agent) {\n        dispatch({\n          type: 'add_agent',\n          agent: {\n            ...existing_agent,\n            color: \"#\" + color_convert.hsv.hex(Math.random() * 360, 100, 100)\n          }\n        })\n        setAgentToAdd(\"\")\n      }\n    }\n\n    return <div>\n        <h4 className=\"text-center mt-3\">Agents Present</h4>\n        <p className=\"small text-secondary text-center\">Applies to the entire video</p>\n\n        <ol className=\"list-unstyled m-3\">\n            {Object.entries(state.agents).map(([id, agent]) => (\n                <SidebarAgent\n                    key={id}\n                    agent={agent}\n                    onColorChange={color => dispatch({ type: 'set_agent_color', agent: id, color })}\n                    onClickEdit={_ => setEditingAgent(id)}\n                    onClickDelete={_ => dispatch({ type: 'delete_agent', agent: id })}\n                />\n            ))}\n        </ol>\n\n      <div className=\"input-group px-2 pb-3\">\n        {/*<Form.Control*/}\n        {/*  type=\"color\"*/}\n        {/*  id=\"new-agent-color\"*/}\n        {/*  defaultValue=\"#563d7c\"*/}\n        {/*  title=\"Agent color\"*/}\n        {/*  style={{ flexGrow: 0, width: \"2.5em\"}}*/}\n        {/*/>*/}\n        <Form.Select\n          aria-label=\"Agent Type\"\n          value={agentToAdd}\n          onChange={e => setAgentToAdd(e.currentTarget.value)}\n        >\n          <option key={\"\"} value={\"\"}>Agent Type&hellip;</option>\n          {agents.map(agent => (\n            <option key={agent.name} value={agent.name}>\n              {agent.display_name}\n            </option>\n          ))}\n        </Form.Select>\n        <Button variant=\"primary\" onClick={_ => addAgent(agentToAdd)} disabled={!agentToAdd}>Add</Button>\n      </div>\n      <AgentEditModal\n              state={state}\n              sample={sample}\n              agent={editingAgent}\n              onClose={_ => setEditingAgent(null)} />\n    </div>\n}\n\nfunction SidebarAgent({ agent, onClickEdit, onClickDelete, onColorChange }) {\n    return (<li className=\"d-flex align-items-center\">\n      <Form.Control\n        type=\"color\"\n        size=\"sm\"\n        className=\"agent-color\"\n        value={agent.color}\n        onChange={e => onColorChange(e.currentTarget.value)}\n        title=\"Agent color\"\n      />\n      <span className=\"flex-grow-1\">{agent.display_name}</span>\n      <Button className=\"icon-button\" size=\"sm\" variant=\"light\" onClick={_ => onClickDelete()}><RiDeleteBack2Fill /></Button>\n      <Button className=\"icon-button\" size=\"sm\" variant=\"light\" onClick={_ => onClickEdit()}><BsPencilSquare /></Button>\n    </li>)\n}\n\nfunction SidebarAgentAnnotation({ state, agentId, agent, label }) {\n    const dispatch = useContext(LabelsDispatch)\n    if (!dispatch) return null\n\n    return <li\n        className={\"list-group-item py-2 px-3 \" + (state.activeAgent === agentId ? 'active' : '')}\n        onClick={() => dispatch({ type: 'set_active_agent', activeAgent: agentId })}\n    >\n        {agent.display_name}\n        <Form>\n            <FormCheck\n                id={`agent-${agentId}-blurred`}\n                label={\"Blurred\"}\n                checked={label?.isBlurred ?? false}\n                onChange={event => dispatch({\n                    type: 'set_agent_is_blurred',\n                    agentId,\n                    isBlurred: event.currentTarget.checked\n                })}\n            />\n            <FormCheck\n                id={`agent-${agent.name}-obscured`}\n                label={\"Obscured\"}\n                checked={label?.isObscured ?? false}\n                onChange={event => dispatch({\n                    type: 'set_agent_is_obscured',\n                    agentId,\n                    isObscured: event.currentTarget.checked\n                })}\n            />\n        </Form>\n    </li>\n}\n\nfunction SidebarAgentAnnotations({ state }) {\n    return <div className=\"flex-grow-1\">\n        <h4 className=\"text-center mt-3\">Agent Annotations</h4>\n        <p className=\"small text-secondary text-center\">Applies to the current frame</p>\n\n        <ul className=\"list-group list-group-flush\">\n            {Object.entries(state.agents).map(([agentId, agent]) =>\n                <SidebarAgentAnnotation\n                    key={agentId}\n                    state={state}\n                    agentId={agentId}\n                    agent={agent}\n                    label={state.frames?.[state.activeFrame]?.[agentId]}\n                />\n            )}\n        </ul>\n        {Object.keys(state.agents).length === 0 && <p className=\"text-center mx-2\">\n            Use the dropdown and button below to add the agent that are present in this video\n        </p>}\n    </div>\n}\n\nexport function Sidebar({ state, sample }) {\n\n    return (<Col md={4} lg={3} xl={2} className=\"bg-light h-100 border-end border-dark d-flex flex-column gx-0\">\n        <SidebarAgentAnnotations state={state} />\n        <SidebarAgentsPresent state={state} sample={sample} />\n    </Col>)\n}","function updateFrame(state, agent, changes) {\n    if (!agent) return state\n    if (typeof changes === \"function\") {\n        changes = changes(state.frames[state.activeFrame]?.[agent] ?? {})\n    }\n    return {\n        ...state,\n        frames: {\n            ...state.frames,\n            [state.activeFrame]: {\n                ...state.frames[state.activeFrame],\n                [agent]: {\n                    ...state.frames[state.activeFrame]?.[agent] ?? {},\n                    ...changes,\n                },\n            },\n        },\n    }\n}\n\nfunction normalizeAngle(angle) {\n    return angle % (Math.PI * 2)\n}\n\nfunction stepAdvanceDispatch(state) {\n    const presentAgentIds = Object.keys(state.agents).sort()\n\n    const idx = presentAgentIds.indexOf(state.activeAgent)\n\n    // First, if there is no active agent, try to activate the first present agent\n    if (!state.activeAgent || idx < 0) {\n        if (presentAgentIds.length > 0) {\n            return { type: 'set_active_agent', activeAgent: presentAgentIds[0] }\n        } else {\n            // If there aren't any present agents, just go to the next frame\n            return { type: 'next_frame' }\n        }\n    }\n\n    // Try to activate the next present agent\n    if (idx + 1 < presentAgentIds.length) {\n        return { type: 'set_active_agent', activeAgent: presentAgentIds[idx + 1] }\n    }\n\n    // If nothing else worked, advance the frame and reset the agent\n    return { type: 'advance_frame_and_set_agent', activeAgent: presentAgentIds[0] }\n}\n\nfunction stepRetreatDispatch(state) {\n    const presentAgentIds = Object.keys(state.agents).sort().reverse()\n\n    const idx = presentAgentIds.indexOf(state.activeAgent)\n\n    // First, if there is no active agent, try to activate the first present agent\n    if (!state.activeAgent || idx < 0) {\n        if (presentAgentIds.length > 0) {\n            return { type: 'set_active_agent', activeAgent: presentAgentIds[0] }\n        } else {\n            // If there aren't any present agents, just go to the previous frame\n            return { type: 'previous_frame' }\n        }\n    }\n\n    // Try to activate the next present agent\n    if (idx + 1 < presentAgentIds.length) {\n        return { type: 'set_active_agent', activeAgent: presentAgentIds[idx + 1] }\n    }\n\n    // If nothing else worked, advance the frame and reset the agent\n    return { type: 'retreat_frame_and_set_agent', activeAgent: presentAgentIds[0] }\n}\n\nfunction clampFrame(settings, frameNum) {\n    // convert to 0-indexed for math\n    frameNum -= 1\n    // clamp to existing frames\n    frameNum = Math.max(0, Math.min(frameNum, settings.numFrames - 1))\n    // round to the sample rate\n    frameNum = Math.round(frameNum / settings.sampleRate) * settings.sampleRate\n    // convert back to 1-indexed\n    frameNum += 1\n    return frameNum\n}\n\nexport default function reducer(state, action) {\n    // The only action that can be performed before initial state is received is to receive the initial state\n    if (!state.settings && action.type !== 'set_state') {\n        console.warn(\"Received\", action.type, \"action before initial state from server\")\n        return state\n    }\n\n    switch (action.type) {\n        case 'set_state':\n            return action.state\n        case 'set_loading_finished':\n            return { ...state, loading: false }\n        case 'set_active_agent':\n            return { ...state, activeAgent: action.activeAgent }\n        case 'set_agent_present':\n            return { ...state, agentPresent: { ...state.agentPresent, [action.agent]: action.isPresent } }\n        case 'set_agent_flipped':\n            return { ...state, agentFlipped: { ...state.agentFlipped, [action.agent]: action.isFlipped } }\n        case 'active_agent_toggle_present':\n            return {\n                ...state,\n                agentPresent: { ...state.agentPresent, [state.activeAgent]: !state.agentPresent[state.activeAgent] },\n            }\n        case 'set_agent_position':\n            return updateFrame(state, action.agentId, { x: action.x, y: action.y })\n        case 'rotate_agent':\n            return updateFrame(state, action.agentId, agent => ({\n                angle: normalizeAngle((agent.angle || 0) + action.by),\n            }))\n        case 'rotate_active_agent':\n            return reducer(state, { type: 'rotate_agent', agentId: state.activeAgent, by: action.by })\n        case 'move_agent':\n            return updateFrame(state, action.agentId, agent => ({\n                x: (agent.x || 0) + (action.x || 0),\n                y: (agent.y || 0) + (action.y || 0),\n            }))\n        case 'move_active_agent':\n            return reducer(state, { type: 'move_agent', agentId: state.activeAgent, x: action.x, y: action.y })\n        case 'next_frame':\n            if (state.loading) return state\n            const prevActiveFrame = state.activeFrame\n            const activeFrame = clampFrame(state.settings, state.activeFrame + state.settings.sampleRate)\n            return {\n                ...state,\n                loading: true,\n                activeFrame,\n                frames: {\n                    ...state.frames,\n                    [activeFrame]: state.frames[activeFrame] ?? state.frames[prevActiveFrame],\n                },\n            }\n        case 'previous_frame':\n            return {\n                ...state,\n                loading: true,\n                activeFrame: clampFrame(state.settings, state.activeFrame - state.settings.sampleRate),\n            }\n        case 'jump_to_frame':\n            return {\n                ...state,\n                loading: true,\n                activeFrame: clampFrame(state.settings, action.frame),\n            }\n        case 'set_agent_is_blurred':\n            return updateFrame(state, action.agentId, { isBlurred: action.isBlurred })\n        case 'toggle_active_agent_is_blurred':\n            return updateFrame(state, state.activeAgent, current => ({ isBlurred: !current.isBlurred }))\n        case 'set_agent_is_obscured':\n            return updateFrame(state, action.agentId, { isObscured: action.isObscured })\n        case 'toggle_active_agent_is_obscured':\n            return updateFrame(state, state.activeAgent, current => ({ isObscured: !current.isObscured }))\n        case 'step_advance':\n            return reducer(state, stepAdvanceDispatch(state))\n        case 'step_retreat':\n            return reducer(state, stepRetreatDispatch(state))\n        case 'advance_frame_and_set_agent':\n            if (state.loading) return state\n            return reducer(\n                    reducer(state, { type: 'next_frame' }),\n                    { type: 'set_active_agent', activeAgent: action.activeAgent })\n        case 'retreat_frame_and_set_agent':\n            if (state.loading) return state\n            return reducer(\n                    reducer(state, { type: 'previous_frame' }),\n                    { type: 'set_active_agent', activeAgent: action.activeAgent })\n        case 'set_dish_mask_position':\n            return {\n                ...state,\n                dishMask: {\n                    ...state.dishMask,\n                    x: action.x,\n                    y: action.y,\n                },\n            }\n        case 'set_dish_mask_radius':\n            return {\n                ...state,\n                dishMask: {\n                    ...state.dishMask,\n                    radius: action.radius,\n                },\n            }\n        case 'reset_dish_mask':\n            return {\n                ...state,\n                dishMask: null,\n            }\n\n        case 'set_dish_mask_locked':\n            return {\n                ...state,\n                dishMask: {\n                    ...state.dishMask,\n                    locked: action.value,\n                },\n            }\n\n        case 'add_agent':\n            return {\n                ...state,\n                agents: {\n                    ...state.agents,\n                    [state.nextAgentId]: action.agent,\n                },\n                nextAgentId: state.nextAgentId + 1,\n            }\n\n        case 'set_agent_color':\n            return {\n                ...state,\n                agents: Object.fromEntries(\n                        Object.entries(state.agents)\n                                .map(([id, agent]) => [id, id === action.agent ? {\n                                    ...agent,\n                                    color: action.color,\n                                } : agent]),\n                ),\n            }\n\n        case 'delete_agent':\n            return {\n                ...state,\n                agents: Object.fromEntries(\n                        Object.entries(state.agents)\n                                .filter(([id, _]) => id !== action.agent),\n                ),\n            }\n\n        case 'set_agent_shape':\n            return {\n                ...state,\n                agents: Object.fromEntries(\n                        Object.entries(state.agents)\n                                .map(([id, agent]) => [id, id === action.agent ? {\n                                    ...agent,\n                                    shape: agent.shape.map((shape, i) => {\n                                        // Ensure the last and first points are always the same\n                                        const shouldChange = (i === action.i) ||\n                                                (i === 0 && action.i === agent.shape.length - 1) ||\n                                                (i === agent.shape.length - 1 && action.i === 0)\n                                        return shouldChange ? [action.shapeX, action.shapeY] : shape\n                                    }),\n                                } : agent]),\n                ),\n            }\n\n        case 'set_agent_display_name':\n            return {\n                ...state,\n                agents: Object.fromEntries(\n                        Object.entries(state.agents)\n                                .map(([id, agent]) => [id, id === action.agent ? {\n                                    ...agent,\n                                    display_name: action.display_name,\n                                } : agent]),\n                ),\n            }\n\n        case 'set_modal':\n            return {\n                ...state,\n                modal: action.value\n            }\n\n        default:\n            throw new Error(\"Unknown reducer action\")\n    }\n}","import { useEffect, useMemo, useReducer, useState } from \"react\"\nimport { Container, Row } from \"react-bootstrap\"\nimport { Sidebar } from \"./Sidebar\"\nimport { VideoLabeler } from \"./VideoLabeler\"\nimport reducer from \"../reducer\"\nimport { LabelsDispatch } from \"./labels\"\nimport { apiBaseUrl } from \"./util\"\n\n// note only keys listed in save_state below are persisted to the server\nconst defaultState = {\n    settings: null,\n    loading: true,\n    modal: false,\n    activeFrame: 1,\n    activeAgent: null,\n    agentPresent: {},\n    agents: {},\n    nextAgentId: 0,\n    frames: {}\n}\n\nconst NO_MATCH = Symbol(\"NO_MATCH\")\n\nexport default function Labeler() {\n    const [state, dispatch] = useReducer(reducer, defaultState, i => i)\n\n    const [sample, setSample] = useState(null)\n\n    const experimentId = useMemo(() => {\n        return new URL(window.location).searchParams.get(\"experiment_id\")\n    }, [])\n\n    useEffect(() => {\n        const controller = new AbortController()\n        const signal = controller.signal\n        fetch(`${apiBaseUrl}/api/experiment?id=${experimentId}`, { signal })\n          .then(response => response.json())\n          .then(sample => {\n              if (signal.aborted) {\n                  console.log(\"State restoration aborted after fetch finished\")\n                  return\n              }\n              setSample(sample)\n\n              const state = { ...defaultState, ...sample.label  }\n              // Have to do this weird inversion of object structure to get settings into redux\n              delete sample.label\n              state.settings = sample\n\n              dispatch({ type: 'set_state', state })\n          })\n          .catch(err => {\n              // AbortError is for intentional aborts using AbortController, so no handling is needed\n              if (err.name === 'AbortError') return\n\n              alert(`Failed to fetch experiment: ${err}`)\n          })\n\n        return () => controller.abort()\n    }, [experimentId])\n\n    useEffect(() => {\n        function listener(event) {\n            const ret = (() => {\n                switch (event.key) {\n                    // Changing frames\n                    case ' ':\n                        return dispatch({ type: 'step_advance' })\n                    case 'b':\n                        return dispatch({ type: 'step_retreat' })\n\n                    // Setting quality\n                    case 'r':\n                        return dispatch({ type: 'toggle_active_agent_is_blurred' })\n                    case 'f':\n                        return dispatch({ type: 'toggle_active_agent_is_obscured' })\n\n                    // Rotating\n                    case 'q':\n                        return dispatch({ type: 'rotate_active_agent', by: 0.01 })\n                    case 'Q':\n                        return dispatch({ type: 'rotate_active_agent', by: 0.1 })\n                    case 'e':\n                        return dispatch({ type: 'rotate_active_agent', by: -0.01 })\n                    case 'E':\n                        return dispatch({ type: 'rotate_active_agent', by: -0.1 })\n\n                    // Translating\n                    case 'w':\n                        return dispatch({ type: 'move_active_agent', y: -1 })\n                    case 'W':\n                        return dispatch({ type: 'move_active_agent', y: -10 })\n                    case 'a':\n                        return dispatch({ type: 'move_active_agent', x: -1 })\n                    case 'A':\n                        return dispatch({ type: 'move_active_agent', x: -10 })\n                    case 's':\n                        return dispatch({ type: 'move_active_agent', y: 1 })\n                    case 'S':\n                        return dispatch({ type: 'move_active_agent', y: 10 })\n                    case 'd':\n                        return dispatch({ type: 'move_active_agent', x: 1 })\n                    case 'D':\n                        return dispatch({ type: 'move_active_agent', x: 10 })\n\n                    default:\n                        break\n                }\n                return NO_MATCH\n            })()\n            if (ret !== NO_MATCH) event.preventDefault()\n            return ret\n        }\n\n        // useEffect's clean up makes this pretty easy\n        if (!state.modal) {\n            document.addEventListener('keypress', listener)\n            return () => document.removeEventListener('keypress', listener)\n        }\n    }, [state.modal])\n\n    // Save on every frame change\n    const hasSample = !!sample\n    useEffect(() => {\n        if (!hasSample || !state.settings) return\n        const save_state = Object.fromEntries(\n          [\"activeFrame\", \"activeAgent\", \"agentPresent\", \"agents\", \"frames\", \"nextAgentId\"]\n            .map(key => [key, state[key]])\n        )\n        fetch(`${apiBaseUrl}/api/set_label?id=${experimentId}`, {\n            method: \"POST\",\n            credentials: \"include\",\n            headers: {\n                'Content-Type': 'application/json'\n                // 'Content-Type': 'application/x-www-form-urlencoded',\n            },\n            body: JSON.stringify(save_state)\n        })\n          .catch(err => {\n              alert(`Failed to save changes: ${err}`)\n          })\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [hasSample, state.activeFrame, experimentId])\n\n    function returnToIndex() {\n        window.location = `${apiBaseUrl}/`\n    }\n\n    if (!sample) return (<p>Loading&hellip;</p>)\n\n    return (<Container fluid className=\"h-100\">\n        <Row className=\"h-100\">\n            <LabelsDispatch.Provider value={dispatch}>\n                <Sidebar state={state} sample={sample} />\n                <VideoLabeler sample={sample} state={state} returnToIndex={returnToIndex} />\n            </LabelsDispatch.Provider>\n        </Row>\n    </Container>)\n}","import Labeler from \"./components/Labeler\"\n\nimport './App.css'\nimport 'bootstrap/dist/css/bootstrap.css';\n\nfunction App() {\n  return (\n    <div className=\"App\">\n      <Labeler />\n    </div>\n  )\n}\n\nexport default App\n","const reportWebVitals = onPerfEntry => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n      getCLS(onPerfEntry);\n      getFID(onPerfEntry);\n      getFCP(onPerfEntry);\n      getLCP(onPerfEntry);\n      getTTFB(onPerfEntry);\n    });\n  }\n};\n\nexport default reportWebVitals;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport reportWebVitals from './reportWebVitals';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals();\n"],"sourceRoot":""}